<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Troubleshooting Guide - Application Gateway Ingress Controller</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../css/extra.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Troubleshooting Guide";
    var mkdocs_page_input_path = "troubleshooting.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Application Gateway Ingress Controller</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../annotations/">Annotations</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../helm-values-documenation/">Helm Values Configuration Options</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Setup</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../setup/install-existing/">Brownfield Deployment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../setup/install-new-windows-cluster/">Preview - Greenfield Deployment (Windows Cluster)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../setup/install-new/">Greenfield Deployment</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial.e2e-ssl/">Tutorial: Setting up E2E SSL</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial.general/">Tutorial: Basic</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Features</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../features/agic-reconcile/">Agic reconcile</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/appgw-ssl-certificate/">Appgw ssl certificate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/cookie-affinity/">Cookie affinity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/multiple-namespaces/">Multiple Namespace Support</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/private-ip/">Using Private IP for internal routing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../features/probes/">Probes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">How tos</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/continuous-deployment/">Continuous Deployment with AKS and AGIC using Azure Pipelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/dns/">Automate DNS updates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/helm-upgrade/">Upgrading AGIC using Helm</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/lets-encrypt/">Certificate issuance with LetsEncrypt.org</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/minimize-downtime-during-deployments/">Minimizing Downtime During Deployments</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/networking/">How to setup networking between Application Gateway and AKS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/scale-applications-using-appgw-metrics/">Scale your Applications using Application Gateway Metrics (Beta)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../how-tos/websockets/">Websockets</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../faq/">Frequrently Asked Questions: [WIP]</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Troubleshooting Guide</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#troubleshooting-installing-a-simple-application">Troubleshooting: Installing a simple application</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#inspect-kubernetes-installation">Inspect Kubernetes Installation</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#pods-services-ingress">Pods, Services, Ingress</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#verify-observed-nampespace">Verify Observed Nampespace</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#troubleshooting-agic-pod-stuck-in-not-ready-state">Troubleshooting: AGIC pod stuck in not ready state</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#illustration">Illustration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#common-causes">Common causes:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#agic-is-stuck-at-creating-authorizer">AGIC is stuck at creating authorizer</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#issue-in-mic-pod">Issue in MIC Pod</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#issue-in-nmi-pod">Issue in NMI Pod</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#agic-is-stuck-getting-application-gateway">AGIC is stuck getting Application Gateway</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../logging-levels/">Logging Levels</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Developers</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../developers/build/">Building the controller</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../developers/contribute/">Contribution Guidelines</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Application Gateway Ingress Controller</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Troubleshooting Guide</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/troubleshooting.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="troubleshooting-guide">Troubleshooting Guide</h1>
<ol>
<li><a href="#troubleshooting-installing-a-simple-application">Troubleshooting by installing a simple application</a></li>
<li><a href="#troubleshooting-agic-pod-stuck-in-not-ready-state">Troubleshooting issues related to AGIC pod not coming up</a></li>
</ol>
<hr />
<h2 id="troubleshooting-installing-a-simple-application">Troubleshooting: Installing a simple application</h2>
<p><a href="https://shell.azure.com/">Azure Cloud Shell</a> is the most convenient way to troubleshoot any problems with your AKS
and AGIC installation. Launch your shell from <a href="https://shell.azure.com/">shell.azure.com</a> or by clicking the link:</p>
<p><a href="https://shell.azure.com"><img alt="Embed launch" src="https://shell.azure.com/images/launchcloudshell.png" title="Launch Azure Cloud Shell" /></a></p>
<p>In the troubleshooting document, we will debug issues in the AGIC installation by installing a simple application step by step and check the output as we go along.<br />
The steps below assume:
  - You have an AKS cluster, with Advanced Networking enabled
  - AGIC has been installed on the AKS cluster
  - You already hav an App Gateway on a VNET shared with your AKS cluster</p>
<p>To verify that the App Gateway + AKS + AGIC installation is setup correctly, deploy
the simplest possible app:</p>
<pre class="highlight"><code class="language-bash">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: test-agic-app-pod
  labels:
    app: test-agic-app
spec:
  containers:
  - image: "mcr.microsoft.com/dotnet/core/samples:aspnetapp"
    name: aspnetapp-image
    ports:
    - containerPort: 80
      protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: test-agic-app-service
spec:
  selector:
    app: test-agic-app
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: test-agic-app-ingress
  annotations:
    kubernetes.io/ingress.class: azure/application-gateway
spec:
  rules:
    - host: test.agic.contoso.com
      http:
        paths:
          - path: /
            backend:
              serviceName: test-agic-app-service
              servicePort: 80
EOF</code></pre>

<p>Copy and paste all lines at once from the
script above into a <a href="https://shell.azure.com/">Azure Cloud Shell</a>. Please ensure the entire
command is copied - starting with <code>cat</code> and including the last <code>EOF</code>.</p>
<p><img alt="apply" src="../images/tsg--apply-config.png" /></p>
<p>After a successful deployment of the app above your AKS cluster will have a new Pod, Service and an Ingress.</p>
<p>Get the list of pods with <a href="https://shell.azure.com/">Cloud Shell</a>: <code>kubectl get pods -o wide</code>.
We expect for a pod named 'test-agic-app-pod' to have been created. It will have an IP address. This address
must be within the VNET of the App Gateway, which is used with AKS.</p>
<p><img alt="pods" src="../images/tsg--get-pods.png" /></p>
<p>Get the list of services: <code>kubectl get services -o wide</code>. We expect to see a service named
'test-agic-app-service'.</p>
<p><img alt="pods" src="../images/tsg--get-services.png" /></p>
<p>Get the list of the ingresses: <code>kubectl get ingress</code>. We expect an Ingress resource named
'test-agic-app-ingress' to have been created. The resource will have a host name 'test.agic.contoso.com'.</p>
<p><img alt="pods" src="../images/tsg--get-ingress.png" /></p>
<p>One of the pods will be AGIC. <code>kubectl get pods</code> will show a list of pods, one of which will begin
with 'ingress-azure'. Get all logs of that pod with <code>kubectl logs &lt;name-of-ingress-controller-pod&gt;</code>
to verify that we have had a successful deployment. A successful deployment would have added the following
lines to the log:
<pre class="highlight"><code>I0927 22:34:51.281437       1 process.go:156] Applied App Gateway config in 20.461335266s
I0927 22:34:51.281585       1 process.go:165] cache: Updated with latest applied config.
I0927 22:34:51.282342       1 process.go:171] END AppGateway deployment</code></pre></p>
<p>Alternatively, from <a href="https://shell.azure.com/">Cloud Shell</a> we can retrieve only the lines
indicating successful App Gateway configuration with
<code>kubectl logs &lt;ingress-azure-....&gt; | grep 'Applied App Gateway config in'</code>, where
<code>&lt;ingress-azure....&gt;</code> should be the exact name of the AGIC pod.</p>
<p>App Gateway will have the following configuration applied:</p>
<ul>
<li>
<p>Listener:
<img alt="listener" src="../images/tsg--listeners.png" /></p>
</li>
<li>
<p>Routing Rule:
<img alt="routing_rule" src="../images/tsg--rule.png" /></p>
</li>
<li>
<p>Backend Pool:</p>
</li>
<li>There will be one IP address in the backend address pool and it will match the IP address of the Pod we observed earlier with <code>kubectl get pods -o wide</code>
<img alt="backend_pool" src="../images/tsg--backendpools.png" /></li>
</ul>
<p>Finally we can use the <code>cURL</code> command from within <a href="https://shell.azure.com/">Cloud Shell</a> to
establish an HTTP connection to the newly deployed app:</p>
<ol>
<li>Use <code>kubectl get ingress</code> to get the Public IP address of App Gateway</li>
<li>Use <code>curl -I -H 'Host: test.agic.contoso.com' &lt;publitc-ip-address-from-previous-command&gt;</code></li>
</ol>
<p><img alt="pods" src="../images/tsg--curl.png" /></p>
<p>A result of <code>HTTP/1.1 200 OK</code> indicates that the App Gateway + AKS + AGIC system is working as expected.</p>
<h3 id="inspect-kubernetes-installation">Inspect Kubernetes Installation</h3>
<h4 id="pods-services-ingress">Pods, Services, Ingress</h4>
<p>Application Gateway Ingress Controller (AGIC) continuously monitors the folowing Kubernetes resources: <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment">Deployment</a> or <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/#what-is-a-pod">Pod</a>, <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Service</a>, <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a></p>
<p>The following must be in place for AGIC to function as expected:
  1. AKS must have one or more healthy <strong>pods</strong>.
     Verify this from <a href="https://shell.azure.com/">Cloud Shell</a> with <code>kubectl get pods -o wide --show-labels</code>
     If you have a Pod with an <code>apsnetapp</code>, your output may look like this:
     <pre class="highlight"><code class="language-bash">$&gt; kubectl get pods -o wide --show-labels

NAME                   READY   STATUS    RESTARTS   AGE   IP          NODE                       NOMINATED NODE   READINESS GATES   LABELS
aspnetapp              1/1     Running   0          17h   10.0.0.6    aks-agentpool-35064155-1   &lt;none&gt;           &lt;none&gt;            app=aspnetapp</code></pre></p>
<ol>
<li>
<p>One or more <strong>services</strong>, referencing the pods above via matching <code>selector</code> labels.
     Verify this from <a href="https://shell.azure.com/">Cloud Shell</a> with <code>kubectl get services -o wide</code>
     <pre class="highlight"><code class="language-bash">$&gt; kubectl get services -o wide --show-labels

NAME                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR        LABELS
aspnetapp           ClusterIP   10.2.63.254    &lt;none&gt;        80/TCP    17h   app=aspnetapp   &lt;none&gt;     </code></pre></p>
</li>
<li>
<p><strong>Ingress</strong>, annotated with <code>kubernetes.io/ingress.class: azure/application-gateway</code>, referencing the service above
     Verify this from <a href="https://shell.azure.com/">Cloud Shell</a> with <code>kubectl get ingress -o wide --show-labels</code>
     <pre class="highlight"><code class="language-bash">$&gt; kubectl get ingress -o wide --show-labels

NAME        HOSTS   ADDRESS   PORTS   AGE   LABELS
aspnetapp   *                 80      17h   &lt;none&gt;</code></pre></p>
</li>
<li>
<p>View annotations of the ingress above: <code>kubectl get ingress aspnetapp -o yaml</code> (substitute <code>aspnetapp</code> with the name of your ingress)
     <pre class="highlight"><code class="language-bash">$&gt; kubectl get ingress aspnetapp -o yaml

apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: azure/application-gateway
  name: aspnetapp
spec:
  backend:
    serviceName: aspnetapp
    servicePort: 80</code></pre></p>
<p>The ingress resource must be annotated with <code>kubernetes.io/ingress.class: azure/application-gateway</code>.</p>
</li>
</ol>
<h4 id="verify-observed-nampespace">Verify Observed Nampespace</h4>
<ul>
<li>
<p>Get the existing namespaces in Kubernetes cluster. What namespace is your app
running in? Is AGIC watching that namespace? Refer to the
<a href="../features/multiple-namespaces/#enable-multiple-namespace-support">Multiple Namespace Support</a>
documentation on how to properly configure observed namespaces.
    <pre class="highlight"><code class="language-bash"># What namespaces exist on your cluster
kubectl get namespaces

# What pods are currently running
kubectl get pods --all-namespaces -o wide</code></pre></p>
</li>
<li>
<p>The AGIC pod should be in the <code>default</code> namespace (see column <code>NAMESPACE</code>). A healthy pod would have <code>Running</code> in the <code>STATUS</code> column. There should be at least one AGIC pod.
    <pre class="highlight"><code class="language-bash"># Get a list of the Application Gateway Ingress Controller pods
kubectl get pods --all-namespaces --selector app=ingress-azure</code></pre></p>
</li>
<li>
<p>If the AGIC pod is not healthy (<code>STATUS</code> column from the command above is not <code>Running</code>):</p>
</li>
<li>get logs to understand why: <code>kubectl logs &lt;pod-name&gt;</code></li>
<li>for the previous instance of the pod: <code>kubectl logs &lt;pod-name&gt; --previous</code></li>
<li>
<p>describe the pod to get more context: <code>kubectl describe pod &lt;pod-name&gt;</code></p>
</li>
<li>
<p>Do you have a Kubernetes
<a href="https://kubernetes.io/docs/concepts/services-networking/service/">Service</a> and
<a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a> resources?
    <pre class="highlight"><code class="language-bash"># Get all services across all namespaces
kubectl get service --all-namespaces -o wide

# Get all ingress resources across all namespaces
kubectl get ingress --all-namespaces -o wide</code></pre></p>
</li>
<li>
<p>Is your <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a> annotated with: <code>kubernetes.io/ingress.class: azure/application-gateway</code>? AGIC will only watch for Kubernetes Ingress resources that have this annotation.
    <pre class="highlight"><code class="language-bash"># Get the YAML definition of a particular ingress resource
kubectl get ingress --namespace  &lt;which-namespace?&gt;  &lt;which-ingress?&gt;  -o yaml</code></pre></p>
</li>
<li>
<p>AGIC emits Kubernetes events for certain critical errors. You can view these:</p>
</li>
<li>in your terminal via <code>kubectl get events --sort-by=.metadata.creationTimestamp</code></li>
<li>in your browser using the <a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">Kubernetes Web UI (Dashboard)</a></li>
</ul>
<hr />
<h2 id="troubleshooting-agic-pod-stuck-in-not-ready-state">Troubleshooting: AGIC pod stuck in not ready state</h2>
<h3 id="illustration">Illustration</h3>
<p>If AGIC pod is stuck in ready state, you must be seeing the following:
<pre class="highlight"><code>$ kubectl get pods

NAME                                   READY   STATUS    RESTARTS   AGE
&lt;AGIC-POD-NAME&gt;                        0/1     Running   0          19s
mic-774b9c5d7b-z4z8p                   1/1     Running   1          15m
mic-774b9c5d7b-zrdsm                   1/1     Running   1          15m
nmi-pv8ch       </code></pre></p>
<h3 id="common-causes">Common causes:</h3>
<ol>
<li><a href="#agic-is-stuck-at-creating-authorizer">Stuck at creating authorizer</a></li>
<li><a href="#agic-is-stuck-getting-application-gateway">Stuck getting Application Gateway</a></li>
</ol>
<h3 id="agic-is-stuck-at-creating-authorizer">AGIC is stuck at creating authorizer</h3>
<p>When the AGIC pod starts, in one of the steps, AGIC tries to get an AAD (Azure Active Directory) token for the identity assigned to it. This token is then used to perform updates on the Application gateway.<br />
This identity can be of two types:
1. User Assigned Identity
1. Service Principal</p>
<p>When using User Assigned identity with AGIC, AGIC has a dependency on <a href="https://github.com/Azure/aad-pod-identity"><code>AAD Pod Identity</code></a>.<br />
When you see your AGIC pod stuck at <code>Creating Authorizer</code> step, then the issue could be related to the setup of the user assigned identity and AAD Pod Identity.</p>
<pre class="highlight"><code>$ kubectl logs &lt;AGIC-POD-NAME&gt;
ERROR: logging before flag.Parse: I0628 18:09:49.947221       1 utils.go:115] Using verbosity level 3 from environment variable APPGW_VERBOSITY_LEVEL
I0628 18:09:49.987776       1 environment.go:240] KUBERNETES_WATCHNAMESPACE is not set. Watching all available namespaces.
I0628 18:09:49.987861       1 main.go:128] Appication Gateway Details: Subscription="xxxx" Resource Group="resgp" Name="gateway"
I0628 18:09:49.987873       1 auth.go:46] Creating authorizer from Azure Managed Service Identity
I0628 18:09:49.987945       1 httpserver.go:57] Starting API Server on :8123</code></pre>

<p><code>AAD Pod Identity</code> is responsible for assigning the user assigned identity provided by the user for AGIC as <code>AGIC's Identity</code> to the underlying AKS nodes and setup the IP table rules to allow AGIC to get an AAD token from the Instance Metadata service on the VM. When you install <code>AAD Pod Identity</code> on your AKS cluster, it will deploy two components:
1. Managed Identity Controller (MIC): It runs with multiple replicas and one Pod is <strong>elected leader</strong>. It is responsible to do the assignment of the identity to the AKS nodes.
1. Node Managed Identity (NMI): It runs as <strong>daemon on every node</strong>. It is responsible to enforce the IP table rules to allow AGIC to <code>GET</code> the access token.</p>
<p>For further reading on how these components work, you can go through <a href="https://github.com/Azure/aad-pod-identity#components">this readme</a>. Here is a <a href="https://github.com/Azure/aad-pod-identity/blob/master/docs/design/concept.png">concept diagram</a> on the project page.</p>
<p>Now, In order to debug the authorizer issue further, we need to get the logs for <code>mic</code> and <code>nmi</code> pods. These pods usually start with mic and nmi as the prefix. We should first investigate the logs of <code>mic</code> and then <code>nmi</code>.</p>
<pre class="highlight"><code>$ kubectl get pods

NAME                                   READY   STATUS    RESTARTS   AGE
mic-774b9c5d7b-z4z8p                   1/1     Running   1          15m
mic-774b9c5d7b-zrdsm                   1/1     Running   1          15m
nmi-pv8ch                              1/1     Running   1          15m</code></pre>

<h6 id="issue-in-mic-pod">Issue in MIC Pod</h6>
<p>For <code>mic</code> pod, we will need to find the leader. An easy way to find the leader is by looking at the log size. Leader pod is the one that is actively working.
1. MIC pod communicates with Azure Resource Manager(ARM) to assign the identity to the AKS nodes. If there are any issues in outbound connectivity, MIC can report TCP timeouts. Check your NSGs, UDRs and Firewall to make sure that you allow outbound traffic to Azure.
    <pre class="highlight"><code>Updating msis on node aks-agentpool-41724381-vmss, add [1], del [1], update[0] failed with error azure.BearerAuthorizer#WithAuthorization: Failed to refresh the Token for request to https://management.azure.com/subscriptions/xxxx/resourceGroups/resgp/providers/Microsoft.Compute/virtualMachineScaleSets/aks-agentpool-41724381-vmss?api-version=2019-07-01: StatusCode=0 -- Original Error: adal: Failed to execute the refresh request. Error = 'Post "https://login.microsoftonline.com/&lt;tenantId&gt;/oauth2/token?api-version=1.0": dial tcp: i/o timeout'</code></pre>
1. You will see the following error if AKS cluster's <code>Service Principal</code> missing <code>Managed Identity Operator</code> access over User Assigned identity. You can follow the role assignment related step in the <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/docs/setup/install-existing.md#set-up-aad-pod-identity">brownfield document</a>.
    <pre class="highlight"><code>Updating msis on node aks-agentpool-32587779-vmss, add [1], del [0] failed with error compute.VirtualMachineScaleSetsClient#CreateOrUpdate: Failure sending request: StatusCode=403 -- Original Error: Code="LinkedAuthorizationFailed" Message="The client '&lt;objectID&gt;' with object id '&lt;objectID&gt;' has permission to perform action 'Microsoft.Compute/virtualMachineScaleSets/write' on scope '/subscriptions/xxxx/resourceGroups/&lt;nodeResourceGroup&gt;/providers/Microsoft.Compute/virtualMachineScaleSets/aks-agentpool-32587779-vmss'; however, it does not have permission to perform action 'Microsoft.ManagedIdentity/userAssignedIdentities/assign/action' on the linked scope(s) '/subscriptions/xxxx/resourcegroups/resgp/providers/Microsoft.ManagedIdentity/userAssignedIdentities/&lt;identityName&gt;' or the linked scope(s) are invalid."</code></pre></p>
<h6 id="issue-in-nmi-pod">Issue in NMI Pod</h6>
<p>For <code>nmi</code> pod, we will need to find the pod running on the same node as AGIC pod.
1. If you see <code>403</code> response for a token request, then make sure you have correctly assigned the needed permission to <code>AGIC's identity</code>.
    1. <code>Reader</code> accesss to Application Gateway's resource group. This is needed to list the resources in the this resource group.
    1. <code>Contributor</code> access to Application Gateway. This is needed to perform updates on the Application Gateway.</p>
<h3 id="agic-is-stuck-getting-application-gateway">AGIC is stuck getting Application Gateway</h3>
<p>AGIC can be stuck in getting the gateway due to:
1. AGIC gets <code>NotFound</code> when getting Application Gateway<br />
When you see this error,
    1. Verify that the gateway actually exists in the subscription and resource group printed in the AGIC logs.
    1. If you are deploying in National Cloud or US Gov Cloud, then this issue could be related to incorrect environment endpoint setting. To correctly configure, set the <a href="../helm-values-documenation/"><code>appgw.environment</code></a> property in the helm.
1. AGIC gets <code>Unauthorized</code> when getting Application Gateway<br />
Verify that you have given needed permissions to AGIC's identity:
    1. <code>Reader</code> accesss to Application Gateway's resource group. This is needed to list the resources in the this resource group.
    1. <code>Contributor</code> access to Application Gateway. This is needed to perform updates on the Application Gateway.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../logging-levels/" class="btn btn-neutral float-right" title="Logging Levels">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../faq/" class="btn btn-neutral" title="Frequrently Asked Questions: [WIP]"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../faq/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../logging-levels/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
