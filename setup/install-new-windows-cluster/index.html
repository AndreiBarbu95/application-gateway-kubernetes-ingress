<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Preview - Greenfield Deployment (Windows Cluster) - Application Gateway Ingress Controller</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../../css/extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Preview - Greenfield Deployment (Windows Cluster)";
    var mkdocs_page_input_path = "setup/install-new-windows-cluster.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Application Gateway Ingress Controller</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../annotations/">Annotations</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../helm-values-documenation/">Helm Values Configuration Options</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Setup</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../install-existing/">Brownfield Deployment</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Preview - Greenfield Deployment (Windows Cluster)</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#preview-greenfield-deployment-windows-cluster">Preview - Greenfield Deployment (Windows Cluster)</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#required-command-line-tools">Required Command Line Tools</a></li>
        
            <li><a class="toctree-l4" href="#enable-you-subscription-to-support-preview-features-for-kubernetes">Enable you Subscription to support preview features for Kubernetes</a></li>
        
            <li><a class="toctree-l4" href="#create-an-identity">Create an Identity</a></li>
        
            <li><a class="toctree-l4" href="#deploy-components">Deploy Components</a></li>
        
            <li><a class="toctree-l4" href="#set-up-application-gateway-ingress-controller">Set up Application Gateway Ingress Controller</a></li>
        
            <li><a class="toctree-l4" href="#other-examples">Other Examples</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../install-new/">Greenfield Deployment</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tutorials</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../tutorials/tutorial.e2e-ssl/">Tutorial: Setting up E2E SSL</a>
                </li>
                <li class="">
                    
    <a class="" href="../../tutorials/tutorial.general/">Tutorial: Basic</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Features</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../features/agic-reconcile/">Agic reconcile</a>
                </li>
                <li class="">
                    
    <a class="" href="../../features/appgw-ssl-certificate/">Appgw ssl certificate</a>
                </li>
                <li class="">
                    
    <a class="" href="../../features/cookie-affinity/">Cookie affinity</a>
                </li>
                <li class="">
                    
    <a class="" href="../../features/custom-ingress-class/">Custom Ingress Class</a>
                </li>
                <li class="">
                    
    <a class="" href="../../features/multiple-namespaces/">Multiple Namespace Support</a>
                </li>
                <li class="">
                    
    <a class="" href="../../features/private-ip/">Using Private IP for internal routing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../features/probes/">Probes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">How tos</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../how-tos/continuous-deployment/">Continuous Deployment with AKS and AGIC using Azure Pipelines</a>
                </li>
                <li class="">
                    
    <a class="" href="../../how-tos/dns/">Automate DNS updates</a>
                </li>
                <li class="">
                    
    <a class="" href="../../how-tos/helm-upgrade/">Upgrading AGIC using Helm</a>
                </li>
                <li class="">
                    
    <a class="" href="../../how-tos/lets-encrypt/">Certificate issuance with LetsEncrypt.org</a>
                </li>
                <li class="">
                    
    <a class="" href="../../how-tos/minimize-downtime-during-deployments/">Minimizing Downtime During Deployments</a>
                </li>
                <li class="">
                    
    <a class="" href="../../how-tos/networking/">How to setup networking between Application Gateway and AKS</a>
                </li>
                <li class="">
                    
    <a class="" href="../../how-tos/scale-applications-using-appgw-metrics/">Scale your Applications using Application Gateway Metrics (Beta)</a>
                </li>
                <li class="">
                    
    <a class="" href="../../how-tos/websockets/">Websockets</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../faq/">Frequrently Asked Questions: [WIP]</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Troubleshootings</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../troubleshootings/">Troubleshooting Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../../troubleshootings/troubleshooting-agic-addon-identity-not-found/">Troubleshooting agic addon identity not found</a>
                </li>
                <li class="">
                    
    <a class="" href="../../troubleshootings/troubleshooting-agic-fails-with-aad-pod-identity-breakingchange/">Troubleshooting agic fails with aad pod identity breakingchange</a>
                </li>
                <li class="">
                    
    <a class="" href="../../troubleshootings/troubleshooting-agic-pod-stuck-in-not-ready-state/">Troubleshooting agic pod stuck in not ready state</a>
                </li>
                <li class="">
                    
    <a class="" href="../../troubleshootings/troubleshooting-installing-a-simple-application/">Troubleshooting installing a simple application</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../logging-levels/">Logging Levels</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Developers</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../developers/build/">Building the controller</a>
                </li>
                <li class="">
                    
    <a class="" href="../../developers/contribute/">Contribution Guidelines</a>
                </li>
                <li class="">
                    
    <a class="" href="../../developers/design/">Application Gateway Ingress Controller Design (WIP)</a>
                </li>
                <li class="">
                    
    <a class="" href="../../developers/developer-guideline/">Application Gateway Ingress Controller Development Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../../developers/nightly/">Install the latest nightly build</a>
                </li>
                <li class="">
                    
    <a class="" href="../../developers/test/">Testing the controller</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Application Gateway Ingress Controller</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Setup &raquo;</li>
        
      
    
    <li>Preview - Greenfield Deployment (Windows Cluster)</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/setup/install-new-windows-cluster.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="preview-greenfield-deployment-windows-cluster">Preview - Greenfield Deployment (Windows Cluster)</h1>
<p>The instructions below assume Application Gateway Ingress Controller (AGIC) will be
installed in an environment with no pre-existing components.</p>
<h3 id="required-command-line-tools">Required Command Line Tools</h3>
<p>We recommend the use of <a href="https://shell.azure.com/">Azure Cloud Shell</a> for all command line operations below. Launch your shell from shell.azure.com or by clicking the link:</p>
<p><a href="https://shell.azure.com"><img alt="Embed launch" src="https://shell.azure.com/images/launchcloudshell.png" title="Launch Azure Cloud Shell" /></a></p>
<p>Alternatively, launch Cloud Shell from Azure portal using the following icon:</p>
<p><img alt="Portal launch" src="../../portal-launch-icon.png" /></p>
<p>Your <a href="https://shell.azure.com/">Azure Cloud Shell</a> already has all necessary tools. Should you
choose to use another environment, please ensure the following command line tools are installed:</p>
<ol>
<li><code>az</code> - Azure CLI: <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">installation instructions</a></li>
<li><code>kubectl</code> - Kubernetes command-line tool: <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl">installation instructions</a></li>
<li><code>helm</code> - Kubernetes package manager: <a href="https://github.com/helm/helm/releases/latest">installation instructions</a></li>
<li><code>jq</code> - command-line JSON processor: <a href="https://stedolan.github.io/jq/download/">installation instructions</a></li>
</ol>
<h3 id="enable-you-subscription-to-support-preview-features-for-kubernetes">Enable you Subscription to support preview features for Kubernetes</h3>
<p>Here are the steps to instal aks-preview CLI and register Windows preview feature.</p>
<blockquote>
<p>[!IMPORTANT]
AKS preview features are self-service opt-in. Previews are provided "as-is" and "as available" and are excluded from the service level agreements and limited warranty. AKS Previews are partially covered by customer support on best effort basis. As such, these features are not meant for production use. For additional infromation, please see the following support articles:</p>
<ul>
<li>[AKS Support Policies][aks-support-policies]</li>
<li>[Azure Support FAQ][aks-faq]</li>
</ul>
</blockquote>
<h4 id="install-aks-preview-cli-extension">Install aks-preview CLI extension</h4>
<p>To use Windows Server containers, you need the <em>aks-preview</em> CLI extension version 0.4.12 or higher. Install the <em>aks-preview</em> Azure CLI extension using the [az extension add][az-extension-add] command, then check for any available updates using the [az extension update][az-extension-update] command::</p>
<div class="highlight"><pre><span></span># Install the aks-preview extension
az extension add --name aks-preview

# Update the extension to make sure you have the latest version installed
az extension update --name aks-preview
</pre></div>

<h4 id="register-windows-preview-feature">Register Windows preview feature</h4>
<p>To create an AKS cluster that can use multiple node pools and run Windows Server containers, first enable the <em>WindowsPreview</em> feature flags on your subscription. The <em>WindowsPreview</em> feature also uses multi-node pool clusters and virtual machine scale set to manage the deployment and configuration of the Kubernetes nodes. Register the  <em>WindowsPreview</em> feature flag using the [az feature register][az-feature-register] command as shown in the following example:</p>
<div class="highlight"><pre><span></span>az feature register --name WindowsPreview --namespace Microsoft.ContainerService
</pre></div>

<blockquote>
<p>[!NOTE]
Any AKS cluster you create after you've successfully registered the <em>WindowsPreview</em> feature flag use this preview cluster experience. To continue to create regular, fully-supported clusters, don't enable preview features on production subscriptions. Use a separate test or development Azure subscription for testing preview features.</p>
</blockquote>
<p>It takes a few minutes for the registration to complete. Check on the registration status using the [az feature list][az-feature-list] command:</p>
<div class="highlight"><pre><span></span>az feature list -o table --query &quot;[?contains(name, &#39;Microsoft.ContainerService/WindowsPreview&#39;)].{Name:name,State:properties.state}&quot;
</pre></div>

<p>When the registration state is <code>Registered</code>, press Ctrl-C to stop monitoring the state.  Then refresh the registration of the <em>Microsoft.ContainerService</em> resource provider using the [az provider register][az-provider-register] command:</p>
<div class="highlight"><pre><span></span>az provider register --namespace Microsoft.ContainerService
</pre></div>

<h4 id="limitations">Limitations</h4>
<p>The following limitations apply when you create and manage AKS clusters that support multiple node pools:</p>
<ul>
<li>You can't delete the first node pool.</li>
</ul>
<p>While this feature is in preview, the following additional limitations apply:</p>
<ul>
<li>The AKS cluster can have a maximum of eight node pools.</li>
<li>The AKS cluster can have a maximum of 400 nodes across those eight node pools.</li>
<li>The Windows Server node pool name has a limit of 6 characters.</li>
</ul>
<h3 id="create-an-identity">Create an Identity</h3>
<p>Follow the steps below to create an Azure Active Directory (AAD) <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals#service-principal-object">service principal object</a>. Please record the <code>appId</code>, <code>password</code>, and <code>objectId</code> values - these will be used in the following steps.</p>
<ol>
<li>
<p>Create AD service principal (<a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/overview">Read more about RBAC</a>). Paste the following lines in your <a href="https://shell.azure.com/">Azure Cloud Shell</a>:
    <div class="highlight"><pre><span></span>az ad sp create-for-rbac --skip-assignment -o json &gt; auth.json
<span class="nv">appId</span><span class="o">=</span><span class="k">$(</span>jq -r <span class="s2">&quot;.appId&quot;</span> auth.json<span class="k">)</span>
<span class="nv">password</span><span class="o">=</span><span class="k">$(</span>jq -r <span class="s2">&quot;.password&quot;</span> auth.json<span class="k">)</span>
</pre></div>
        These commands will create <code>appId</code> and <code>password</code> bash variables, which will be used in the steps below. You can view the value of these with <code>echo $appId</code> and <code>echo $password</code>.</p>
</li>
<li>
<p>Execute the next command in <a href="https://shell.azure.com/">Cloud Shell</a> to create the <code>objectId</code> bash variable, which is the new Service Princpial:
    <div class="highlight"><pre><span></span><span class="nv">objectId</span><span class="o">=</span><span class="k">$(</span>az ad sp show --id <span class="nv">$appId</span> --query <span class="s2">&quot;objectId&quot;</span> -o tsv<span class="k">)</span>
</pre></div>
    The <code>objectId</code> bash variable will be used in the ARM template below. View the value with <code>echo $objectId</code>.</p>
</li>
<li>
<p>Paste the entire command below (it is a single command on multiple lines) in <a href="https://shell.azure.com/">Cloud Shell</a> to create the parameters.json file. It will be used in the ARM template deployment.
    <div class="highlight"><pre><span></span>cat <span class="s">&lt;&lt;EOF &gt; parameters.json</span>
<span class="s">{</span>
<span class="s">  &quot;aksServicePrincipalAppId&quot;: { &quot;value&quot;: &quot;$appId&quot; },</span>
<span class="s">  &quot;aksServicePrincipalClientSecret&quot;: { &quot;value&quot;: &quot;$password&quot; },</span>
<span class="s">  &quot;aksServicePrincipalObjectId&quot;: { &quot;value&quot;: &quot;$objectId&quot; },</span>
<span class="s">  &quot;aksEnableRBAC&quot;: { &quot;value&quot;: false }</span>
<span class="s">}</span>
<span class="s">EOF</span>
</pre></div>
    To deploy an <strong>RBAC</strong> enabled cluster, set the <code>aksEnabledRBAC</code> field to <code>true</code>. View the contents of the newly created file with <code>cat parameters.json</code>. It will contain the values of the <code>appId</code>, <code>password</code>, and <code>objectId</code> bash variables from the previous steps.</p>
</li>
</ol>
<h3 id="deploy-components">Deploy Components</h3>
<p>The next few steps will add the following list of components to your Azure subscription:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes">Azure Kubernetes Service</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/application-gateway/overview">Application Gateway</a> v2</li>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview">Virtual Network</a> with 2 <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview">subnets</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-public-ip-address">Public IP Address</a></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview">Managed Identity</a>, which will be used by <a href="https://github.com/Azure/aad-pod-identity/blob/master/README.md">AAD Pod Identity</a></p>
</li>
<li>
<p>Download the ARM template into template.json file. Paste the following in your <a href="https://shell.azure.com/">shell</a>:
    <div class="highlight"><pre><span></span>wget https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/master/deploy/azuredeploywindowscluster.json -O template.json
</pre></div></p>
</li>
<li>
<p>Deploy the ARM template via <a href="https://shell.azure.com/">Azure Cloud Shell</a> and the <code>az</code> tool. Modify the name of the resource group and region/location, then paste each of the following lines into your <a href="https://shell.azure.com/">shell</a>:
    <div class="highlight"><pre><span></span><span class="nv">resourceGroupName</span><span class="o">=</span><span class="s2">&quot;MyResourceGroup&quot;</span>

<span class="nv">location</span><span class="o">=</span><span class="s2">&quot;westus2&quot;</span>

<span class="nv">deploymentName</span><span class="o">=</span><span class="s2">&quot;ingress-appgw&quot;</span>

az group create -n <span class="nv">$resourceGroupName</span> -l <span class="nv">$location</span>

az group deployment create -g <span class="nv">$resourceGroupName</span> -n <span class="nv">$deploymentName</span> --template-file template.json --parameters parameters.json
</pre></div>
    Note: The last command may take a few minutes to complete.</p>
</li>
<li>
<p>Once the deployment finished, download the deployment output into a file named <code>deployment-outputs.json</code>.
    <div class="highlight"><pre><span></span>az group deployment show -g <span class="nv">$resourceGroupName</span> -n <span class="nv">$deploymentName</span> --query <span class="s2">&quot;properties.outputs&quot;</span> -o json &gt; deployment-outputs.json
</pre></div>
    View the content of the newly created file with: <code>cat deployment-outputs.json</code>. The file will have the following shape (example):
    <div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;aksApiServerAddress&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;aks-abcd41e9.hcp.westus2.azmk8s.io&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;aksClusterName&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;aksabcd&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;applicationGatewayName&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;applicationgatewayabcd&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;identityClientId&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;7b1a3378-8abe-ab58-cca9-a8ef624db293&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;identityResourceId&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/a6466a81-bf0d-147e-2acb-a0ba50f6456e/resourceGroups/MyResourceGroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/appgwContrIdentityabcd&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;resourceGroupName&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;MyResourceGroup&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;subscriptionId&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;a6466a81-bf0d-147e-2acb-a0ba50f6456e&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></p>
</li>
</ul>
<h2 id="set-up-application-gateway-ingress-controller">Set up Application Gateway Ingress Controller</h2>
<p>With the instructions in the previous section we created and configured a new AKS cluster and
an App Gateway. We are now ready to deploy a sample app and an ingress controller to our new
Kubernetes infrastructure.</p>
<h3 id="setup-kubernetes-credentials">Setup Kubernetes Credentials</h3>
<p>For the following steps we need setup <a href="https://kubectl.docs.kubernetes.io/">kubectl</a> command,
which we will use to connect to our new Kubernetes cluster. <a href="https://shell.azure.com/">Cloud Shell</a> has <code>kubectl</code> already installed. We will use <code>az</code> CLI to obtain credentials for Kubernetes.</p>
<p>Get credentials for your newly deployed AKS (<a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough#connect-to-the-cluster">read more</a>):
<div class="highlight"><pre><span></span><span class="c1"># use the deployment-outputs.json created after deployment to get the cluster name and resource group name</span>
<span class="nv">aksClusterName</span><span class="o">=</span><span class="k">$(</span>jq -r <span class="s2">&quot;.aksClusterName.value&quot;</span> deployment-outputs.json<span class="k">)</span>
<span class="nv">resourceGroupName</span><span class="o">=</span><span class="k">$(</span>jq -r <span class="s2">&quot;.resourceGroupName.value&quot;</span> deployment-outputs.json<span class="k">)</span>

az aks get-credentials --resource-group <span class="nv">$resourceGroupName</span> --name <span class="nv">$aksClusterName</span>
</pre></div></p>
<h3 id="install-aad-pod-identity">Install AAD Pod Identity</h3>
<p>Azure Active Directory Pod Identity provides token-based access to
  <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview">Azure Resource Manager (ARM)</a>.</p>
<p><a href="https://github.com/Azure/aad-pod-identity">AAD Pod Identity</a> will add the following components to your Kubernetes cluster:
   1. Kubernetes <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/">CRDs</a>: <code>AzureIdentity</code>, <code>AzureAssignedIdentity</code>, <code>AzureIdentityBinding</code>
   1. <a href="https://github.com/Azure/aad-pod-identity#managed-identity-controller">Managed Identity Controller (MIC)</a> component
   1. <a href="https://github.com/Azure/aad-pod-identity#node-managed-identity">Node Managed Identity (NMI)</a> component</p>
<p>To install AAD Pod Identity to your cluster:</p>
<ul>
<li><em>RBAC enabled</em> AKS cluster</li>
</ul>
<div class="highlight"><pre><span></span>kubectl apply -f https://raw.githubusercontent.com/Azure/aad-pod-identity/v1.6.0/deploy/infra/deployment-rbac.yaml
</pre></div>

<ul>
<li><em>RBAC disabled</em> AKS cluster</li>
</ul>
<div class="highlight"><pre><span></span>kubectl apply -f https://raw.githubusercontent.com/Azure/aad-pod-identity/v1.6.0/deploy/infra/deployment.yaml
</pre></div>

<h3 id="install-helm">Install Helm</h3>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-helm">Helm</a> is a package manager for
Kubernetes. This document will use version 3 of helm, which is not backwards compatbile with previous versions.</p>
<ol>
<li>Add the AGIC Helm repository:
    <div class="highlight"><pre><span></span>helm repo add application-gateway-kubernetes-ingress https://appgwingress.blob.core.windows.net/ingress-azure-helm-package/
helm repo update
</pre></div></li>
</ol>
<h3 id="install-ingress-controller-helm-chart">Install Ingress Controller Helm Chart</h3>
<ol>
<li>Use the <code>deployment-outputs.json</code> file created above and create the following variables.
    <div class="highlight"><pre><span></span><span class="nv">applicationGatewayName</span><span class="o">=</span><span class="k">$(</span>jq -r <span class="s2">&quot;.applicationGatewayName.value&quot;</span> deployment-outputs.json<span class="k">)</span>
<span class="nv">resourceGroupName</span><span class="o">=</span><span class="k">$(</span>jq -r <span class="s2">&quot;.resourceGroupName.value&quot;</span> deployment-outputs.json<span class="k">)</span>
<span class="nv">subscriptionId</span><span class="o">=</span><span class="k">$(</span>jq -r <span class="s2">&quot;.subscriptionId.value&quot;</span> deployment-outputs.json<span class="k">)</span>
<span class="nv">identityClientId</span><span class="o">=</span><span class="k">$(</span>jq -r <span class="s2">&quot;.identityClientId.value&quot;</span> deployment-outputs.json<span class="k">)</span>
<span class="nv">identityResourceId</span><span class="o">=</span><span class="k">$(</span>jq -r <span class="s2">&quot;.identityResourceId.value&quot;</span> deployment-outputs.json<span class="k">)</span>
</pre></div></li>
<li>
<p>Download <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a>, which will configure AGIC:
    <div class="highlight"><pre><span></span>wget https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/master/docs/examples/sample-helm-config.yaml -O helm-config.yaml
</pre></div></p>
</li>
<li>
<p>Edit the newly downloaded <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a> and fill out the sections <code>appgw</code> and <code>armAuth</code>.
    <div class="highlight"><pre><span></span>sed -i <span class="s2">&quot;s|&lt;subscriptionId&gt;|</span><span class="si">${</span><span class="nv">subscriptionId</span><span class="si">}</span><span class="s2">|g&quot;</span> helm-config.yaml
sed -i <span class="s2">&quot;s|&lt;resourceGroupName&gt;|</span><span class="si">${</span><span class="nv">resourceGroupName</span><span class="si">}</span><span class="s2">|g&quot;</span> helm-config.yaml
sed -i <span class="s2">&quot;s|&lt;applicationGatewayName&gt;|</span><span class="si">${</span><span class="nv">applicationGatewayName</span><span class="si">}</span><span class="s2">|g&quot;</span> helm-config.yaml
sed -i <span class="s2">&quot;s|&lt;identityResourceId&gt;|</span><span class="si">${</span><span class="nv">identityResourceId</span><span class="si">}</span><span class="s2">|g&quot;</span> helm-config.yaml
sed -i <span class="s2">&quot;s|&lt;identityClientId&gt;|</span><span class="si">${</span><span class="nv">identityClientId</span><span class="si">}</span><span class="s2">|g&quot;</span> helm-config.yaml

<span class="c1"># You can further modify the helm config to enable/disable features</span>
nano helm-config.yaml
</pre></div></p>
</li>
</ol>
<p>Values:
- <code>verbosityLevel</code>: Sets the verbosity level of the AGIC logging infrastructure. See <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/463a87213bbc3106af6fce0f4023477216d2ad78/docs/troubleshooting.md#logging-levels">Logging Levels</a> for possible values.
- <code>appgw.subscriptionId</code>: The Azure Subscription ID in which App Gateway resides. Example: <code>a123b234-a3b4-557d-b2df-a0bc12de1234</code>
- <code>appgw.resourceGroup</code>: Name of the Azure Resource Group in which App Gateway was created. Example: <code>app-gw-resource-group</code>
- <code>appgw.name</code>: Name of the Application Gateway. Example: <code>applicationgatewayd0f0</code>
- <code>appgw.usePrivateIP</code>: The boolean flag if all Ingresses are exposed over Private IP. Set to <code>false</code> should you use an <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/docs/features/private-ip.md#assign-globally">Application Gateway v2 SKU</a>
- <code>appgw.shared</code>: This boolean flag should be defaulted to <code>false</code>. Set to <code>true</code> should you need a <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/072626cb4e37f7b7a1b0c4578c38d1eadc3e8701/docs/setup/install-existing.md#multi-cluster--shared-app-gateway">Shared App Gateway</a>.
- <code>kubernetes.watchNamespace</code>: Specify the name space, which AGIC should watch. This could be a single string value, or a comma-separated list of namespaces.
- <code>armAuth.type</code>: could be <code>aadPodIdentity</code> or <code>servicePrincipal</code>
- <code>armAuth.identityResourceID</code>: Resource ID of the Azure Managed Identity
- <code>armAuth.identityClientId</code>: The Client ID of the Identity. See below for more information on Identity
- <code>armAuth.secretJSON</code>: Only needed when Service Principal Secret type is chosen (when <code>armAuth.type</code> has been set to <code>servicePrincipal</code>)
- <code>rbac.enabled</code>: Make sure to set this to true if you have a AKS cluster that is RBAC enabled.</p>
<p>Note on Identity: The <code>identityResourceID</code> and <code>identityClientID</code> are values that were created
   during the <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/072626cb4e37f7b7a1b0c4578c38d1eadc3e8701/docs/setup/install-new.md#create-an-identity">Create an Identity</a>
   steps, and could be obtained again using the following command:
   <div class="highlight"><pre><span></span>az identity show -g &lt;resource-group&gt; -n &lt;identity-name&gt;
</pre></div>
- <code>&lt;resource-group&gt;</code> in the command above is the resource group of your App Gateway. 
- <code>&lt;identity-name&gt;</code> is the name of the created identity. All identities for a given subscription can be listed using: <code>az identity list</code></p>
<ol>
<li>
<p>Install the Application Gateway ingress controller package:</p>
<div class="highlight"><pre><span></span>helm install ingress-azure <span class="se">\</span>
  -f helm-config.yaml <span class="se">\</span>
  application-gateway-kubernetes-ingress/ingress-azure <span class="se">\</span>
  --set nodeSelector.<span class="s2">&quot;beta\.kubernetes\.io/os&quot;</span><span class="o">=</span>linux <span class="se">\</span>
  --version <span class="m">1</span>.3.0
</pre></div>

<blockquote>
<p>Note: Use at least version 1.2.0-rc3, e.g. <code>--version 1.2.0-rc3</code>, when installing on k8s version &gt;= 1.16</p>
</blockquote>
</li>
</ol>
<h3 id="install-a-sample-app">Install a Sample App</h3>
<p>Now that we have App Gateway, AKS, and AGIC installed we can install a sample app
via <a href="https://shell.azure.com/">Azure Cloud Shell</a>:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">cat &lt;&lt;EOF | kubectl apply -f -</span>
<span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aspnetapp</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aspnetapp</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">nodeSelector</span><span class="p">:</span>
    <span class="s">&quot;beta.kubernetes.io/os&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">windows</span>
  <span class="nt">containers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="s">&quot;mcr.microsoft.com/dotnet/framework/samples:aspnetapp&quot;</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aspnetapp-image</span>
    <span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
      <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>

<span class="nn">---</span>

<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aspnetapp</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aspnetapp</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>

<span class="nn">---</span>

<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aspnetapp</span>
  <span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure/application-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">rules</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">http</span><span class="p">:</span>
      <span class="nt">paths</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
        <span class="nt">backend</span><span class="p">:</span>
          <span class="nt">serviceName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aspnetapp</span>
          <span class="nt">servicePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="l l-Scalar l-Scalar-Plain">EOF</span>
</pre></div>

<p>Alternatively you can:</p>
<ol>
<li>
<p>Download the YAML file above:
<div class="highlight"><pre><span></span>curl https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/master/docs/examples/aspnetappwin.yaml -o aspnetapp.yaml
</pre></div></p>
</li>
<li>
<p>Apply the YAML file:
<div class="highlight"><pre><span></span>kubectl apply -f aspnetapp.yaml
</pre></div></p>
</li>
</ol>
<h2 id="other-examples">Other Examples</h2>
<p>The <strong><a href="../../tutorials/tutorial.general/">tutorials</a></strong> document contains more examples on how to expose an AKS
service via HTTP or HTTPS, to the Internet with App Gateway.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../install-new/" class="btn btn-neutral float-right" title="Greenfield Deployment">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../install-existing/" class="btn btn-neutral" title="Brownfield Deployment"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../install-existing/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../install-new/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
