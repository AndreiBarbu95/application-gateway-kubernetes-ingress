<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Preview - Greenfield Deployment (Windows Cluster) - Application Gateway Ingress Controller</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../css/extra.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Preview - Greenfield Deployment (Windows Cluster)";
    var mkdocs_page_input_path = "setup/install-new-windows-cluster.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Application Gateway Ingress Controller</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Setup</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../install-existing/">Brownfield Deployment</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Preview - Greenfield Deployment (Windows Cluster)</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#required-command-line-tools">Required Command Line Tools</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#enable-you-subscription-to-support-preview-features-for-kubernetes">Enable you Subscription to support preview features for Kubernetes</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#install-aks-preview-cli-extension">Install aks-preview CLI extension</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#register-windows-preview-feature">Register Windows preview feature</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#limitations">Limitations</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#create-an-identity">Create an Identity</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#deploy-components">Deploy Components</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#set-up-application-gateway-ingress-controller">Set up Application Gateway Ingress Controller</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#setup-kubernetes-credentials">Setup Kubernetes Credentials</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#install-aad-pod-identity">Install AAD Pod Identity</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#install-helm">Install Helm</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#install-ingress-controller-helm-chart">Install Ingress Controller Helm Chart</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#install-a-sample-app">Install a Sample App</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#other-examples">Other Examples</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../install-new/">Greenfield Deployment</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorial/">Tutorials</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../annotations/">Annotations</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Features</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/agic-reconcile/">Agic reconcile</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/appgw-ssl-certificate/">Appgw ssl certificate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/cookie-affinity/">Cookie affinity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/multiple-namespaces/">Multiple Namespace Support</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/private-ip/">Using Private IP for internal routing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/probes/">Probes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">How tos</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/continuous-deployment/">Continuous Deployment with AKS and AGIC using Azure Pipelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/dns/">Automate DNS updates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/helm-upgrade/">Upgrading AGIC using Helm</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/lets-encrypt/">Certificate issuance with LetsEncrypt.org</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/minimize-downtime-during-deployments/">Minimizing Downtime During Deployments</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/scale-applications-using-appgw-metrics/">Scale your Applications using Application Gateway Metrics (Beta)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/websockets/">Websockets</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequrently Asked Questions: [WIP]</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/">Troubleshooting</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Developers</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/build/">Building the controller</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/contribute/">Contribution Guidelines</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Application Gateway Ingress Controller</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Setup &raquo;</li>
        
      
    
    <li>Preview - Greenfield Deployment (Windows Cluster)</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/setup/install-new-windows-cluster.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="preview-greenfield-deployment-windows-cluster">Preview - Greenfield Deployment (Windows Cluster)</h1>
<p>The instructions below assume Application Gateway Ingress Controller (AGIC) will be
installed in an environment with no pre-existing components.</p>
<h3 id="required-command-line-tools">Required Command Line Tools</h3>
<p>We recommend the use of <a href="https://shell.azure.com/">Azure Cloud Shell</a> for all command line operations below. Launch your shell from shell.azure.com or by clicking the link:</p>
<p><a href="https://shell.azure.com"><img alt="Embed launch" src="https://shell.azure.com/images/launchcloudshell.png" title="Launch Azure Cloud Shell" /></a></p>
<p>Alternatively, launch Cloud Shell from Azure portal using the following icon:</p>
<p><img alt="Portal launch" src="../../portal-launch-icon.png" /></p>
<p>Your <a href="https://shell.azure.com/">Azure Cloud Shell</a> already has all necessary tools. Should you
choose to use another environment, please ensure the following command line tools are installed:</p>
<ol>
<li><code>az</code> - Azure CLI: <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">installation instructions</a></li>
<li><code>kubectl</code> - Kubernetes command-line tool: <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl">installation instructions</a></li>
<li><code>helm</code> - Kubernetes package manager: <a href="https://github.com/helm/helm/releases/latest">installation instructions</a></li>
<li><code>jq</code> - command-line JSON processor: <a href="https://stedolan.github.io/jq/download/">installation instructions</a></li>
</ol>
<h3 id="enable-you-subscription-to-support-preview-features-for-kubernetes">Enable you Subscription to support preview features for Kubernetes</h3>
<p>Here are the steps to instal aks-preview CLI and register Windows preview feature.</p>
<blockquote>
<p>[!IMPORTANT]
AKS preview features are self-service opt-in. Previews are provided "as-is" and "as available" and are excluded from the service level agreements and limited warranty. AKS Previews are partially covered by customer support on best effort basis. As such, these features are not meant for production use. For additional infromation, please see the following support articles:</p>
<ul>
<li>[AKS Support Policies][aks-support-policies]</li>
<li>[Azure Support FAQ][aks-faq]</li>
</ul>
</blockquote>
<h4 id="install-aks-preview-cli-extension">Install aks-preview CLI extension</h4>
<p>To use Windows Server containers, you need the <em>aks-preview</em> CLI extension version 0.4.12 or higher. Install the <em>aks-preview</em> Azure CLI extension using the [az extension add][az-extension-add] command, then check for any available updates using the [az extension update][az-extension-update] command::</p>
<pre class="highlight"><code class="language-azurecli-interactive"># Install the aks-preview extension
az extension add --name aks-preview

# Update the extension to make sure you have the latest version installed
az extension update --name aks-preview</code></pre>

<h4 id="register-windows-preview-feature">Register Windows preview feature</h4>
<p>To create an AKS cluster that can use multiple node pools and run Windows Server containers, first enable the <em>WindowsPreview</em> feature flags on your subscription. The <em>WindowsPreview</em> feature also uses multi-node pool clusters and virtual machine scale set to manage the deployment and configuration of the Kubernetes nodes. Register the  <em>WindowsPreview</em> feature flag using the [az feature register][az-feature-register] command as shown in the following example:</p>
<pre class="highlight"><code class="language-azurecli-interactive">az feature register --name WindowsPreview --namespace Microsoft.ContainerService</code></pre>

<blockquote>
<p>[!NOTE]
Any AKS cluster you create after you've successfully registered the <em>WindowsPreview</em> feature flag use this preview cluster experience. To continue to create regular, fully-supported clusters, don't enable preview features on production subscriptions. Use a separate test or development Azure subscription for testing preview features.</p>
</blockquote>
<p>It takes a few minutes for the registration to complete. Check on the registration status using the [az feature list][az-feature-list] command:</p>
<pre class="highlight"><code class="language-azurecli-interactive">az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/WindowsPreview')].{Name:name,State:properties.state}"</code></pre>

<p>When the registration state is <code>Registered</code>, press Ctrl-C to stop monitoring the state.  Then refresh the registration of the <em>Microsoft.ContainerService</em> resource provider using the [az provider register][az-provider-register] command:</p>
<pre class="highlight"><code class="language-azurecli-interactive">az provider register --namespace Microsoft.ContainerService</code></pre>

<h4 id="limitations">Limitations</h4>
<p>The following limitations apply when you create and manage AKS clusters that support multiple node pools:</p>
<ul>
<li>You can't delete the first node pool.</li>
</ul>
<p>While this feature is in preview, the following additional limitations apply:</p>
<ul>
<li>The AKS cluster can have a maximum of eight node pools.</li>
<li>The AKS cluster can have a maximum of 400 nodes across those eight node pools.</li>
<li>The Windows Server node pool name has a limit of 6 characters.</li>
</ul>
<h3 id="create-an-identity">Create an Identity</h3>
<p>Follow the steps below to create an Azure Active Directory (AAD) <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals#service-principal-object">service principal object</a>. Please record the <code>appId</code>, <code>password</code>, and <code>objectId</code> values - these will be used in the following steps.</p>
<ol>
<li>
<p>Create AD service principal (<a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/overview">Read more about RBAC</a>). Paste the following lines in your <a href="https://shell.azure.com/">Azure Cloud Shell</a>:
    <pre class="highlight"><code class="language-bash">az ad sp create-for-rbac --skip-assignment -o json &gt; auth.json
appId=$(jq -r ".appId" auth.json)
password=$(jq -r ".password" auth.json)</code></pre>
        These commands will create <code>appId</code> and <code>password</code> bash variables, which will be used in the steps below. You can view the value of these with <code>echo $appId</code> and <code>echo $password</code>.</p>
</li>
<li>
<p>Execute the next command in <a href="https://shell.azure.com/">Cloud Shell</a> to create the <code>objectId</code> bash variable, which is the new Service Princpial:
    <pre class="highlight"><code class="language-bash">objectId=$(az ad sp show --id $appId --query "objectId" -o tsv)</code></pre>
    The <code>objectId</code> bash variable will be used in the ARM template below. View the value with <code>echo $objectId</code>.</p>
</li>
<li>
<p>Paste the entire command below (it is a single command on multiple lines) in <a href="https://shell.azure.com/">Cloud Shell</a> to create the parameters.json file. It will be used in the ARM template deployment.
    <pre class="highlight"><code class="language-bash">cat &lt;&lt;EOF &gt; parameters.json
{
  "aksServicePrincipalAppId": { "value": "$appId" },
  "aksServicePrincipalClientSecret": { "value": "$password" },
  "aksServicePrincipalObjectId": { "value": "$objectId" },
  "aksEnableRBAC": { "value": false }
}
EOF</code></pre>
    To deploy an <strong>RBAC</strong> enabled cluster, set the <code>aksEnabledRBAC</code> field to <code>true</code>. View the contents of the newly created file with <code>cat parameters.json</code>. It will contain the values of the <code>appId</code>, <code>password</code>, and <code>objectId</code> bash variables from the previous steps.</p>
</li>
</ol>
<h3 id="deploy-components">Deploy Components</h3>
<p>The next few steps will add the following list of components to your Azure subscription:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes">Azure Kubernetes Service</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/application-gateway/overview">Application Gateway</a> v2</li>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview">Virtual Network</a> with 2 <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview">subnets</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-public-ip-address">Public IP Address</a></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview">Managed Identity</a>, which will be used by <a href="https://github.com/Azure/aad-pod-identity/blob/master/README.md">AAD Pod Identity</a></p>
</li>
<li>
<p>Download the ARM template into template.json file. Paste the following in your <a href="https://shell.azure.com/">shell</a>:
    <pre class="highlight"><code class="language-bash">wget https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/master/deploy/azuredeploywindowscluster.json -O template.json</code></pre></p>
</li>
<li>
<p>Deploy the ARM template via <a href="https://shell.azure.com/">Azure Cloud Shell</a> and the <code>az</code> tool. Modify the name of the resource group and region/location, then paste each of the following lines into your <a href="https://shell.azure.com/">shell</a>:
    <pre class="highlight"><code class="language-bash">resourceGroupName="MyResourceGroup"

location="westus2"

deploymentName="ingress-appgw"

az group create -n $resourceGroupName -l $location

az group deployment create -g $resourceGroupName -n $deploymentName --template-file template.json --parameters parameters.json</code></pre>
    Note: The last command may take a few minutes to complete.</p>
</li>
<li>
<p>Once the deployment finished, download the deployment output into a file named <code>deployment-outputs.json</code>.
    <pre class="highlight"><code class="language-bash">az group deployment show -g $resourceGroupName -n $deploymentName --query "properties.outputs" -o json &gt; deployment-outputs.json</code></pre>
    View the content of the newly created file with: <code>cat deployment-outputs.json</code>. The file will have the following shape (example):
    <pre class="highlight"><code class="language-json">{
  "aksApiServerAddress": {
    "type": "String",
    "value": "aks-abcd41e9.hcp.westus2.azmk8s.io"
  },
  "aksClusterName": {
    "type": "String",
    "value": "aksabcd"
  },
  "applicationGatewayName": {
    "type": "String",
    "value": "applicationgatewayabcd"
  },
  "identityClientId": {
    "type": "String",
    "value": "7b1a3378-8abe-ab58-cca9-a8ef624db293"
  },
  "identityResourceId": {
    "type": "String",
    "value": "/subscriptions/a6466a81-bf0d-147e-2acb-a0ba50f6456e/resourceGroups/MyResourceGroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/appgwContrIdentityabcd"
  },
  "resourceGroupName": {
    "type": "String",
    "value": "MyResourceGroup"
  },
  "subscriptionId": {
    "type": "String",
    "value": "a6466a81-bf0d-147e-2acb-a0ba50f6456e"
  }
}</code></pre></p>
</li>
</ul>
<h2 id="set-up-application-gateway-ingress-controller">Set up Application Gateway Ingress Controller</h2>
<p>With the instructions in the previous section we created and configured a new AKS cluster and
an App Gateway. We are now ready to deploy a sample app and an ingress controller to our new
Kubernetes infrastructure.</p>
<h3 id="setup-kubernetes-credentials">Setup Kubernetes Credentials</h3>
<p>For the following steps we need setup <a href="https://kubectl.docs.kubernetes.io/">kubectl</a> command,
which we will use to connect to our new Kubernetes cluster. <a href="https://shell.azure.com/">Cloud Shell</a> has <code>kubectl</code> already installed. We will use <code>az</code> CLI to obtain credentials for Kubernetes.</p>
<p>Get credentials for your newly deployed AKS (<a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough#connect-to-the-cluster">read more</a>):
<pre class="highlight"><code class="language-bash"># use the deployment-outputs.json created after deployment to get the cluster name and resource group name
aksClusterName=$(jq -r ".aksClusterName.value" deployment-outputs.json)
resourceGroupName=$(jq -r ".resourceGroupName.value" deployment-outputs.json)

az aks get-credentials --resource-group $resourceGroupName --name $aksClusterName</code></pre></p>
<h3 id="install-aad-pod-identity">Install AAD Pod Identity</h3>
<p>Azure Active Directory Pod Identity provides token-based access to
  <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview">Azure Resource Manager (ARM)</a>.</p>
<p><a href="https://github.com/Azure/aad-pod-identity">AAD Pod Identity</a> will add the following components to your Kubernetes cluster:
   1. Kubernetes <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/">CRDs</a>: <code>AzureIdentity</code>, <code>AzureAssignedIdentity</code>, <code>AzureIdentityBinding</code>
   1. <a href="https://github.com/Azure/aad-pod-identity#managed-identity-controller">Managed Identity Controller (MIC)</a> component
   1. <a href="https://github.com/Azure/aad-pod-identity#node-managed-identity">Node Managed Identity (NMI)</a> component</p>
<p>To install AAD Pod Identity to your cluster:</p>
<ul>
<li><em>RBAC enabled</em> AKS cluster</li>
</ul>
<pre class="highlight"><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/Azure/aad-pod-identity/v1.5.5/deploy/infra/deployment-rbac.yaml</code></pre>

<ul>
<li><em>RBAC disabled</em> AKS cluster</li>
</ul>
<pre class="highlight"><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/Azure/aad-pod-identity/v1.5.5/deploy/infra/deployment.yaml</code></pre>

<h3 id="install-helm">Install Helm</h3>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-helm">Helm</a> is a package manager for
Kubernetes. This document will use version 3 of helm, which is not backwards compatbile with previous versions.</p>
<ol>
<li>Add the AGIC Helm repository:
    <pre class="highlight"><code class="language-bash">helm repo add application-gateway-kubernetes-ingress https://appgwingress.blob.core.windows.net/ingress-azure-helm-package/
helm repo update</code></pre></li>
</ol>
<h3 id="install-ingress-controller-helm-chart">Install Ingress Controller Helm Chart</h3>
<ol>
<li>Use the <code>deployment-outputs.json</code> file created above and create the following variables.
    <pre class="highlight"><code class="language-bash">applicationGatewayName=$(jq -r ".applicationGatewayName.value" deployment-outputs.json)
resourceGroupName=$(jq -r ".resourceGroupName.value" deployment-outputs.json)
subscriptionId=$(jq -r ".subscriptionId.value" deployment-outputs.json)
identityClientId=$(jq -r ".identityClientId.value" deployment-outputs.json)
identityResourceId=$(jq -r ".identityResourceId.value" deployment-outputs.json)</code></pre></li>
<li>
<p>Download <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a>, which will configure AGIC:
    <pre class="highlight"><code class="language-bash">wget https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/master/docs/examples/sample-helm-config.yaml -O helm-config.yaml</code></pre></p>
</li>
<li>
<p>Edit the newly downloaded <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a> and fill out the sections <code>appgw</code> and <code>armAuth</code>.
    <pre class="highlight"><code class="language-bash">sed -i "s|&lt;subscriptionId&gt;|${subscriptionId}|g" helm-config.yaml
sed -i "s|&lt;resourceGroupName&gt;|${resourceGroupName}|g" helm-config.yaml
sed -i "s|&lt;applicationGatewayName&gt;|${applicationGatewayName}|g" helm-config.yaml
sed -i "s|&lt;identityResourceId&gt;|${identityResourceId}|g" helm-config.yaml
sed -i "s|&lt;identityClientId&gt;|${identityClientId}|g" helm-config.yaml

# You can further modify the helm config to enable/disable features
nano helm-config.yaml</code></pre></p>
</li>
</ol>
<p>Values:
- <code>verbosityLevel</code>: Sets the verbosity level of the AGIC logging infrastructure. See <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/463a87213bbc3106af6fce0f4023477216d2ad78/docs/troubleshooting.md#logging-levels">Logging Levels</a> for possible values.
- <code>appgw.subscriptionId</code>: The Azure Subscription ID in which App Gateway resides. Example: <code>a123b234-a3b4-557d-b2df-a0bc12de1234</code>
- <code>appgw.resourceGroup</code>: Name of the Azure Resource Group in which App Gateway was created. Example: <code>app-gw-resource-group</code>
- <code>appgw.name</code>: Name of the Application Gateway. Example: <code>applicationgatewayd0f0</code>
- <code>appgw.usePrivateIP</code>: The boolean flag if all Ingresses are exposed over Private IP. Set to <code>false</code> should you use an <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/docs/features/private-ip.md#assign-globally">Application Gateway v2 SKU</a>
- <code>appgw.shared</code>: This boolean flag should be defaulted to <code>false</code>. Set to <code>true</code> should you need a <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/072626cb4e37f7b7a1b0c4578c38d1eadc3e8701/docs/setup/install-existing.md#multi-cluster--shared-app-gateway">Shared App Gateway</a>.
- <code>kubernetes.watchNamespace</code>: Specify the name space, which AGIC should watch. This could be a single string value, or a comma-separated list of namespaces.
- <code>armAuth.type</code>: could be <code>aadPodIdentity</code> or <code>servicePrincipal</code>
- <code>armAuth.identityResourceID</code>: Resource ID of the Azure Managed Identity
- <code>armAuth.identityClientId</code>: The Client ID of the Identity. See below for more information on Identity
- <code>armAuth.secretJSON</code>: Only needed when Service Principal Secret type is chosen (when <code>armAuth.type</code> has been set to <code>servicePrincipal</code>)
- <code>rbac.enabled</code>: Make sure to set this to true if you have a AKS cluster that is RBAC enabled.</p>
<p>Note on Identity: The <code>identityResourceID</code> and <code>identityClientID</code> are values that were created
   during the <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/blob/072626cb4e37f7b7a1b0c4578c38d1eadc3e8701/docs/setup/install-new.md#create-an-identity">Create an Identity</a>
   steps, and could be obtained again using the following command:
   <pre class="highlight"><code class="language-bash">az identity show -g &lt;resource-group&gt; -n &lt;identity-name&gt;</code></pre>
- <code>&lt;resource-group&gt;</code> in the command above is the resource group of your App Gateway. 
- <code>&lt;identity-name&gt;</code> is the name of the created identity. All identities for a given subscription can be listed using: <code>az identity list</code></p>
<ol>
<li>
<p>Install the Application Gateway ingress controller package:</p>
<pre class="highlight"><code class="language-bash">helm install ingress-azure \
  -f helm-config.yaml \
  application-gateway-kubernetes-ingress/ingress-azure \
  --set nodeSelector."beta\.kubernetes\.io/os"=linux \
  --version 1.0.0</code></pre>

<blockquote>
<p>Note: Use at least version 1.2.0-rc1, e.g. <code>--version 1.2.0-rc1</code>, when installing on k8s version &gt;= 1.16</p>
</blockquote>
</li>
</ol>
<h3 id="install-a-sample-app">Install a Sample App</h3>
<p>Now that we have App Gateway, AKS, and AGIC installed we can install a sample app
via <a href="https://shell.azure.com/">Azure Cloud Shell</a>:</p>
<pre class="highlight"><code class="language-yaml">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: aspnetapp
  labels:
    app: aspnetapp
spec:
  nodeSelector:
    "beta.kubernetes.io/os": windows
  containers:
  - image: "mcr.microsoft.com/dotnet/framework/samples:aspnetapp"
    name: aspnetapp-image
    ports:
    - containerPort: 80
      protocol: TCP

---

apiVersion: v1
kind: Service
metadata:
  name: aspnetapp
spec:
  selector:
    app: aspnetapp
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80

---

apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: aspnetapp
  annotations:
    kubernetes.io/ingress.class: azure/application-gateway
spec:
  rules:
  - http:
      paths:
      - path: /
        backend:
          serviceName: aspnetapp
          servicePort: 80
EOF</code></pre>

<p>Alternatively you can:</p>
<ol>
<li>
<p>Download the YAML file above:
<pre class="highlight"><code class="language-bash">curl https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/master/docs/examples/aspnetappwin.yaml -o aspnetapp.yaml</code></pre></p>
</li>
<li>
<p>Apply the YAML file:
<pre class="highlight"><code class="language-bash">kubectl apply -f aspnetapp.yaml</code></pre></p>
</li>
</ol>
<h2 id="other-examples">Other Examples</h2>
<p>The <strong><a href="../../tutorial/">tutorials</a></strong> document contains more examples on how to expose an AKS
service via HTTP or HTTPS, to the Internet with App Gateway.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../install-new/" class="btn btn-neutral float-right" title="Greenfield Deployment">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../install-existing/" class="btn btn-neutral" title="Brownfield Deployment"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../install-existing/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../install-new/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
