<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Brownfield Deployment - Application Gateway Ingress Controller</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../css/extra.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Brownfield Deployment";
    var mkdocs_page_input_path = "setup/install-existing.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Application Gateway Ingress Controller</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Setup</span></p>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Brownfield Deployment</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#outline">Outline:</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#install-helm">Install Helm</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#azure-resource-manager-authentication">Azure Resource Manager Authentication</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#set-up-aad-pod-identity">Set up AAD Pod Identity</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-a-service-principal">Using a Service Principal</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#install-ingress-controller-as-a-helm-chart">Install Ingress Controller as a Helm Chart</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#multi-cluster-shared-app-gateway">Multi-cluster / Shared App Gateway</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#example-scenario">Example Scenario</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#enable-with-new-agic-installation">Enable with new AGIC installation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#broaden-permissions">Broaden permissions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#enable-for-an-existing-agic-installation">Enable for an existing AGIC installation</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../install-new-windows-cluster/">Preview - Greenfield Deployment (Windows Cluster)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../install-new/">Greenfield Deployment</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorial/">Tutorials</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../annotations/">Annotations</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Features</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/agic-reconcile/">Agic reconcile</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/appgw-ssl-certificate/">Appgw ssl certificate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/cookie-affinity/">Cookie affinity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/multiple-namespaces/">Multiple Namespace Support</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/private-ip/">Using Private IP for internal routing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/probes/">Probes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">How tos</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/continuous-deployment/">Continuous Deployment with AKS and AGIC using Azure Pipelines</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/dns/">Automate DNS updates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/helm-upgrade/">Upgrading AGIC using Helm</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/lets-encrypt/">Certificate issuance with LetsEncrypt.org</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/minimize-downtime-during-deployments/">Minimizing Downtime During Deployments</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/scale-applications-using-appgw-metrics/">Scale your Applications using Application Gateway Metrics (Beta)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../how-tos/websockets/">Websockets</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequrently Asked Questions: [WIP]</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/">Troubleshooting</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../helm-values-documenation/">Helm Values Configuration Options</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Developers</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/build/">Building the controller</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers/contribute/">Contribution Guidelines</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Application Gateway Ingress Controller</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Setup &raquo;</li>
        
      
    
    <li>Brownfield Deployment</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/setup/install-existing.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="brownfield-deployment">Brownfield Deployment</h1>
<p>The App Gateway Ingress Controller (AGIC) is a pod within your Kubernetes cluster.
AGIC monitors the Kubernetes <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a>
resources, and creates and applies App Gateway config based on these.</p>
<h3 id="outline">Outline:</h3>
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#azure-resource-manager-authentication">Azure Resource Manager Authentication (ARM)</a><ul>
<li>Option 1: <a href="#set-up-aad-pod-identity">Set up aad-pod-identity</a> and <a href="#create-azure-identity-on-arm">Create Azure Identity on ARM</a></li>
<li>Option 2: <a href="#using-a-service-principal">Using a Service Principal</a></li>
</ul>
</li>
<li><a href="#install-ingress-controller-as-a-helm-chart">Install Ingress Controller using Helm</a></li>
<li><a href="#multi-cluster--shared-app-gateway">Multi-cluster / Shared App Gateway</a>: Install AGIC in an environment, where App Gateway is
shared between one or more AKS clusters and/or other Azure components.</li>
</ul>
<h3 id="prerequisites">Prerequisites</h3>
<p>This documents assumes you already have the following tools and infrastructure installed:
- <a href="https://azure.microsoft.com/en-us/services/kubernetes-service/">AKS</a> with <a href="https://docs.microsoft.com/en-us/azure/aks/configure-azure-cni">Advanced Networking</a> enabled
- <a href="https://docs.microsoft.com/en-us/azure/application-gateway/create-zone-redundant">App Gateway v2</a> in the same virtual network as AKS
- <a href="https://github.com/Azure/aad-pod-identity">AAD Pod Identity</a> installed on your AKS cluster
- <a href="https://shell.azure.com/">Cloud Shell</a> is the Azure shell environment, which has <code>az</code> CLI, <code>kubectl</code>, and <code>helm</code> installed. These tools are required for the commands below.</p>
<p>Please <strong>backup your App Gateway's configuration</strong> before installing AGIC:
  1. using <a href="https://portal.azure.com/">Azure Portal</a> navigate to your <code>App Gateway</code> instance
  2. from <code>Export template</code> click <code>Download</code></p>
<p>The zip file you downloaded will have JSON templates, bash, and PowerShell scripts you could use to restore App
Gateway should that become necessary</p>
<h3 id="install-helm">Install Helm</h3>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-helm">Helm</a> is a package manager for
Kubernetes. We will leverage it to install the <code>application-gateway-kubernetes-ingress</code> package.
Use <a href="https://shell.azure.com/">Cloud Shell</a> to install Helm:</p>
<ol>
<li>Add the AGIC Helm repository:
    <pre class="highlight"><code class="language-bash">helm repo add application-gateway-kubernetes-ingress https://appgwingress.blob.core.windows.net/ingress-azure-helm-package/
helm repo update</code></pre></li>
</ol>
<h3 id="azure-resource-manager-authentication">Azure Resource Manager Authentication</h3>
<p>AGIC communicates with the Kubernetes API server and the Azure Resource Manager. It requires an identity to access
these APIs.</p>
<h3 id="set-up-aad-pod-identity">Set up AAD Pod Identity</h3>
<p><a href="https://github.com/Azure/aad-pod-identity">AAD Pod Identity</a> is a controller, similar to AGIC, which also runs on your
AKS. It binds Azure Active Directory identities to your Kubernetes pods. Identity is required for an application in a
Kubernetes pod to be able to communicate with other Azure components. In the particular case here we need authorization
for the AGIC pod to make HTTP requests to <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview">ARM</a>.</p>
<p>To install AAD Pod Identity to your cluster:</p>
<ul>
<li><em>RBAC enabled</em> AKS cluster</li>
</ul>
<pre class="highlight"><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/Azure/aad-pod-identity/v1.5.5/deploy/infra/deployment-rbac.yaml</code></pre>

<ul>
<li><em>RBAC disabled</em> AKS cluster</li>
</ul>
<pre class="highlight"><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/Azure/aad-pod-identity/v1.5.5/deploy/infra/deployment.yaml</code></pre>

<p>Next we need to create an Azure identity and give it permissions ARM.
Use <a href="https://shell.azure.com/">Cloud Shell</a> to run all of the following commands and create an identity:</p>
<ol>
<li>
<p>Create an Azure identity <strong>in the same resource group as the AKS nodes</strong>. Picking the correct resource group is
important. The resource group required in the command below is <em>not</em> the one referenced on the AKS portal pane. This is
the resource group of the <code>aks-agentpool</code> virtual machines. Typically that resource group starts with <code>MC_</code> and contains
 the name of your AKS. For instance: <code>MC_resourceGroup_aksABCD_westus</code></p>
<pre class="highlight"><code class="language-bash">az identity create -g &lt;agent-pool-resource-group&gt; -n &lt;identity-name&gt;</code></pre>

</li>
<li>
<p>For the role assignment commands below we need to obtain <code>clientId</code> for the newly created identity:</p>
<pre class="highlight"><code class="language-bash">az identity show -g &lt;resourcegroup&gt; -n &lt;identity-name&gt;</code></pre>

</li>
<li>
<p>Give the identity <code>Contributor</code> access to you App Gateway. For this you need the ID of the App Gateway, which will
look something like this: <code>/subscriptions/A/resourceGroups/B/providers/Microsoft.Network/applicationGateways/C</code></p>
<p>Get the list of App Gateway IDs in your subscription with: <code>az network application-gateway list --query '[].id'</code></p>
<pre class="highlight"><code class="language-bash">az role assignment create \
    --role Contributor \
    --assignee &lt;clientId&gt; \
    --scope &lt;App-Gateway-ID&gt;</code></pre>

</li>
<li>
<p>Give the identity <code>Reader</code> access to the App Gateway resource group. The resource group ID would look like:
<code>/subscriptions/A/resourceGroups/B</code>. You can get all resource groups with: <code>az group list --query '[].id'</code></p>
<pre class="highlight"><code class="language-bash">az role assignment create \
    --role Reader \
    --assignee &lt;clientId&gt; \
    --scope &lt;App-Gateway-Resource-Group-ID&gt;</code></pre>

</li>
</ol>
<h3 id="using-a-service-principal">Using a Service Principal</h3>
<p>It is also possible to provide AGIC access to ARM via a Kubernetes secret.</p>
<ol>
<li>Create an Active Directory Service Principal and encode with base64. The base64 encoding is required for the JSON
  blob to be saved to Kubernetes.</li>
</ol>
<pre class="highlight"><code class="language-bash">az ad sp create-for-rbac --sdk-auth | base64 -w0</code></pre>

<ol>
<li>Add the base64 encoded JSON blob to the <code>helm-config.yaml</code> file. More information on <code>helm-config.yaml</code> is in the
  next section.
   <pre class="highlight"><code class="language-yaml">armAuth:
    type: servicePrincipal
    secretJSON: &lt;Base64-Encoded-Credentials&gt;</code></pre></li>
</ol>
<h2 id="install-ingress-controller-as-a-helm-chart">Install Ingress Controller as a Helm Chart</h2>
<p>You can use <a href="https://shell.azure.com/">Cloud Shell</a> to install the AGIC Helm package:</p>
<ol>
<li>
<p>Add the <code>application-gateway-kubernetes-ingress</code> helm repo and perform a helm update</p>
<pre class="highlight"><code class="language-bash">helm repo add application-gateway-kubernetes-ingress https://appgwingress.blob.core.windows.net/ingress-azure-helm-package/
helm repo update</code></pre>

</li>
<li>
<p>Download <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a>, which will configure AGIC:
    <pre class="highlight"><code class="language-bash">wget https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/master/docs/examples/sample-helm-config.yaml -O helm-config.yaml</code></pre></p>
</li>
<li>
<p>Edit <a href="../../examples/sample-helm-config.yaml">helm-config.yaml</a> and fill in the values for <code>appgw</code> and <code>armAuth</code>.
    <pre class="highlight"><code class="language-bash">nano helm-config.yaml</code></pre></p>
<p><strong>NOTE:</strong> The <code>&lt;identity-resource-id&gt;</code> and <code>&lt;identity-client-id&gt;</code> are the properties of the Azure AD Identity you setup in the previous section. You can retrieve this information by running the following command: <code>az identity show -g &lt;resourcegroup&gt; -n &lt;identity-name&gt;</code>, where <code>&lt;resourcegroup&gt;</code> is the resource group in which the top level AKS cluster object, Application Gateway and Managed Identify are deployed.</p>
</li>
<li>
<p>Install Helm chart <code>application-gateway-kubernetes-ingress</code> with the <code>helm-config.yaml</code> configuration from the previous step</p>
<pre class="highlight"><code class="language-bash">helm install ingress-azure \
  -f helm-config.yaml \
  application-gateway-kubernetes-ingress/ingress-azure \
  --version 1.0.0</code></pre>

<blockquote>
<p>Note: Use at least version 1.2.0-rc1, e.g. <code>--version 1.2.0-rc1</code>, when installing on k8s version &gt;= 1.16</p>
</blockquote>
<p>Alternatively you can combine the <code>helm-config.yaml</code> and the Helm command in one step:
<pre class="highlight"><code class="language-bash">helm install ingress-azure application-gateway-kubernetes-ingress/ingress-azure \
     --namespace default \
     --debug \
     --set appgw.name=applicationgatewayABCD \
     --set appgw.resourceGroup=your-resource-group \
     --set appgw.subscriptionId=subscription-uuid \
     --set appgw.usePrivateIP=false \
     --set appgw.shared=false \
     --set armAuth.type=servicePrincipal \
     --set armAuth.secretJSON=$(az ad sp create-for-rbac --sdk-auth | base64 -w0) \
     --set rbac.enabled=true \
     --set verbosityLevel=3 \
     --set kubernetes.watchNamespace=default \
     --version 1.0.0</code></pre></p>
<blockquote>
<p>Note: Use at least version 1.2.0-rc1, e.g. <code>--version 1.2.0-rc1</code>, when installing on k8s version &gt;= 1.16</p>
</blockquote>
</li>
<li>
<p>Check the log of the newly created pod to verify if it started properly</p>
</li>
</ol>
<p>Refer to the <a href="../../tutorial/">tutorials</a> to understand how you can expose an AKS service over HTTP or HTTPS, to the internet, using an Azure App Gateway.</p>
<h2 id="multi-cluster-shared-app-gateway">Multi-cluster / Shared App Gateway</h2>
<p>By default AGIC assumes full ownership of the App Gateway it is linked to. AGIC version 0.8.0 and later can
share a single App Gateway with other Azure components. For instance, we could use the same App Gateway for an app
hosted on VMSS as well as an AKS cluster.</p>
<p>Please <strong>backup your App Gateway's configuration</strong> before enabling this setting:
  1. using <a href="https://portal.azure.com/">Azure Portal</a> navigate to your <code>App Gateway</code> instance
  2. from <code>Export template</code> click <code>Download</code></p>
<p>The zip file you downloaded will have JSON templates, bash, and PowerShell scripts you could use to restore App Gateway</p>
<h3 id="example-scenario">Example Scenario</h3>
<p>Let's look at an imaginary App Gateway, which manages traffic for 2 web sites:
  - <code>dev.contoso.com</code> - hosted on a new AKS, using App Gateway and AGIC
  - <code>prod.contoso.com</code> - hosted on an <a href="https://azure.microsoft.com/en-us/services/virtual-machine-scale-sets/">Azure VMSS</a></p>
<p>With default settings, AGIC assumes 100% ownership of the App Gateway it is pointed to. AGIC overwrites all of App
Gateway's configuration. If we were to manually create a listener for <code>prod.contoso.com</code> (on App Gateway), without
defining it in the Kubernetes Ingress, AGIC will delete the <code>prod.contoso.com</code> config within seconds.</p>
<p>To install AGIC and also serve <code>prod.contoso.com</code> from our VMSS machines, we must constrain AGIC to configuring
<code>dev.contoso.com</code> only. This is facilitated by instantiating the following
<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRD</a>:</p>
<pre class="highlight"><code class="language-bash">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: "appgw.ingress.k8s.io/v1"
kind: AzureIngressProhibitedTarget
metadata:
  name: prod-contoso-com
spec:
  hostname: prod.contoso.com
EOF</code></pre>

<p>The command above creates an <code>AzureIngressProhibitedTarget</code> object. This makes AGIC (version 0.8.0 and later) aware of the existence of
App Gateway config for <code>prod.contoso.com</code> and explicitly instructs it to avoid changing any configuration
related to that hostname.</p>
<h3 id="enable-with-new-agic-installation">Enable with new AGIC installation</h3>
<p>To limit AGIC (version 0.8.0 and later) to a subset of the App Gateway configuration modify the <code>helm-config.yaml</code> template.
Under the <code>appgw:</code> section, add <code>shared</code> key and set it to to <code>true</code>.</p>
<pre class="highlight"><code class="language-yaml">appgw:
    subscriptionId: &lt;subscriptionId&gt;    # existing field
    resourceGroup: &lt;resourceGroupName&gt;  # existing field
    name: &lt;applicationGatewayName&gt;      # existing field
    shared: true                        # &lt;&lt;&lt;&lt;&lt; Add this field to enable shared App Gateway &gt;&gt;&gt;&gt;&gt;</code></pre>

<p>Apply the Helm changes:
  1. Ensure the <code>AzureIngressProhibitedTarget</code> CRD is installed with:
      <pre class="highlight"><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/ae695ef9bd05c8b708cedf6ff545595d0b7022dc/crds/AzureIngressProhibitedTarget.yaml</code></pre>
  2. Update Helm:
      <pre class="highlight"><code class="language-bash">helm upgrade \
    --recreate-pods \
    -f helm-config.yaml \
    ingress-azure application-gateway-kubernetes-ingress/ingress-azure</code></pre></p>
<p>As a result your AKS will have a new instance of <code>AzureIngressProhibitedTarget</code> called <code>prohibit-all-targets</code>:
<pre class="highlight"><code class="language-bash">kubectl get AzureIngressProhibitedTargets prohibit-all-targets -o yaml</code></pre></p>
<p>The object <code>prohibit-all-targets</code>, as the name implies, prohibits AGIC from changing config for <em>any</em> host and path.
Helm install with <code>appgw.shared=true</code> will deploy AGIC, but will not make any changes to App Gateway.</p>
<h3 id="broaden-permissions">Broaden permissions</h3>
<p>Since Helm with <code>appgw.shared=true</code> and the default <code>prohibit-all-targets</code> blocks AGIC from applying any config.</p>
<p>Broaden AGIC permissions with:
1. Create a new <code>AzureIngressProhibitedTarget</code> with your specific setup:
    <pre class="highlight"><code class="language-bash">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: "appgw.ingress.k8s.io/v1"
kind: AzureIngressProhibitedTarget
metadata:
  name: your-custom-prohibitions
spec:
  hostname: your.own-hostname.com
EOF</code></pre></p>
<ol>
<li>
<p>Only after you have created your own custom prohibition, you can delete the default one, which is too broad:</p>
<pre class="highlight"><code class="language-bash">kubectl delete AzureIngressProhibitedTarget prohibit-all-targets</code></pre>

</li>
</ol>
<h3 id="enable-for-an-existing-agic-installation">Enable for an existing AGIC installation</h3>
<p>Let's assume that we already have a working AKS, App Gateway, and configured AGIC in our cluster. We have an Ingress for
<code>prod.contosor.com</code> and are successfully serving traffic for it from AKS. We want to add <code>staging.contoso.com</code> to our
existing App Gateway, but need to host it on a <a href="https://azure.microsoft.com/en-us/services/virtual-machines/">VM</a>. We
are going to re-use the existing App Gateway and manually configure a listener and backend pools for
<code>staging.contoso.com</code>. But manually tweaking App Gateway config (via
<a href="https://portal.azure.com">portal</a>, <a href="https://docs.microsoft.com/en-us/rest/api/resources/">ARM APIs</a> or
<a href="https://www.terraform.io/">Terraform</a>) would conflict with AGIC's assumptions of full ownership. Shortly after we apply
changes, AGIC will overwrite or delete them.</p>
<p>We can prohibit AGIC from making changes to a subset of configuration.</p>
<ol>
<li>
<p>Create an <code>AzureIngressProhibitedTarget</code> object:
    <pre class="highlight"><code class="language-bash">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: "appgw.ingress.k8s.io/v1"
kind: AzureIngressProhibitedTarget
metadata:
  name: manually-configured-staging-environment
spec:
  hostname: staging.contoso.com
EOF</code></pre></p>
</li>
<li>
<p>View the newly created object:
    <pre class="highlight"><code class="language-bash">kubectl get AzureIngressProhibitedTargets</code></pre></p>
</li>
<li>
<p>Modify App Gateway config via portal - add listeners, routing rules, backends etc. The new object we created
(<code>manually-configured-staging-environment</code>) will prohibit AGIC from overwriting App Gateway configuration related to
<code>staging.contoso.com</code>.</p>
</li>
</ol>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../install-new-windows-cluster/" class="btn btn-neutral float-right" title="Preview - Greenfield Deployment (Windows Cluster)">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../.." class="btn btn-neutral" title="Introduction"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../.." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../install-new-windows-cluster/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
