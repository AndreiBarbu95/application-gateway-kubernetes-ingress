<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>How to setup networking between Application Gateway and AKS - Application Gateway Ingress Controller</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "How to setup networking between Application Gateway and AKS";
        var mkdocs_page_input_path = "how-tos/networking.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/go.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Application Gateway Ingress Controller
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../annotations/">Annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../helm-values-documenation/">Helm Values Configuration Options</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Setup</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/install-existing/">Brownfield Deployment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/install-new-windows-cluster/">Preview - Greenfield Deployment (Windows Cluster)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/install-new/">Greenfield Deployment</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorials</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial.e2e-ssl/">Tutorial: Setting up E2E SSL</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorial.general/">Tutorial: Basic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/agic-reconcile/">Agic reconcile</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/appgw-ssl-certificate/">Appgw ssl certificate</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/cookie-affinity/">Cookie affinity</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/custom-ingress-class/">Custom Ingress Class</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/multiple-namespaces/">Multiple Namespace Support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/private-ip/">Using Private IP for internal routing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/probes/">Probes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">How tos</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../continuous-deployment/">Continuous Deployment with AKS and AGIC using Azure Pipelines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dns/">Automate DNS updates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../helm-upgrade/">Upgrading AGIC using Helm</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lets-encrypt/">Certificate issuance with LetsEncrypt.org</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../minimize-downtime-during-deployments/">Minimizing Downtime During Deployments</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">How to setup networking between Application Gateway and AKS</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#virtual-network-configuration">Virtual Network Configuration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#deployed-in-same-virtual-network">Deployed in same virtual network</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#deployed-in-different-vnets">Deployed in different vnets</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#network-plugin-used-with-aks">Network Plugin used with AKS</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#with-azure-cni">With Azure CNI</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#with-kubenet">With Kubenet</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scale-applications-using-appgw-metrics/">Scale your Applications using Application Gateway Metrics (Beta)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../update-website/">Install MKDocs and plugins</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../websockets/">Websockets</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequrently Asked Questions: [WIP]</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Troubleshootings</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/">Troubleshooting Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-addon-identity-not-found/">Troubleshooting agic addon identity not found</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-fails-with-aad-pod-identity-breakingchange/">Troubleshooting agic fails with aad pod identity breakingchange</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-agic-pod-stuck-in-not-ready-state/">Troubleshooting agic pod stuck in not ready state</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshootings/troubleshooting-installing-a-simple-application/">Troubleshooting installing a simple application</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../ingress-v1/">Ingress v1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../logging-levels/">Logging Levels</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Developers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/build/">Building the controller</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/contribute/">Contribution Guidelines</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/design/">Application Gateway Ingress Controller Design (WIP)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/developer-guideline/">Application Gateway Ingress Controller Development Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/nightly/">Install the latest nightly build</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../developers/test/">Testing the controller</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Application Gateway Ingress Controller</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>How tos &raquo;</li><li>How to setup networking between Application Gateway and AKS</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/Azure/application-gateway-kubernetes-ingress/edit/master/docs/how-tos/networking.md"> Edit on Azure/application-gateway-kubernetes-ingress</a>
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="how-to-setup-networking-between-application-gateway-and-aks">How to setup networking between Application Gateway and AKS</h1>
<p>When you are using Application Gateway with AKS for L7, you need to make sure that you have setup network connectivity correctly between the gateway and the cluster. Otherwise, you might receive 502s when reaching your site.</p>
<p>There are two major things to consider when setting up network connectivity between Application Gateway and AKS
1. Virtual Network Configuration
    * When AKS and Application Gateway in the <a href="#deployed-in-same-vnet">same virtual network</a>
    * When AKS and Application Gateway in <a href="#deployed-in-different-vnets">different virtual networks</a>
1. Network Plugin used with AKS
    * <a href="#with-kubenet">Kubenet</a>
    * <a href="#with-azure-cni">Azure(advanced) CNI</a></p>
<h2 id="virtual-network-configuration">Virtual Network Configuration</h2>
<h3 id="deployed-in-same-virtual-network">Deployed in same virtual network</h3>
<p>If you have deployed AKS and Application Gateway in the same virtual network with <code>Azure CNI</code> for network plugin, then you don't have to do any changes and you are good to go. Application Gateway instances should be able to reach the PODs.</p>
<p>If you are using <code>kubenet</code> network plugin, then jump to <a href="#with-kubenet">Kubenet</a> to setup the route table.</p>
<h3 id="deployed-in-different-vnets">Deployed in different vnets</h3>
<p>AKS can be deployed in different virtual network from Application Gateway's virtual network, however, the two virtual networks must be <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview">peered</a> together. When you create a virtual network peering between two virtual networks, a route is added by Azure for each address range within the address space of each virtual network a peering is created for.</p>
<div class="highlight"><pre><span></span><span class="nv">aksClusterName</span><span class="o">=</span><span class="s2">&quot;&lt;aksClusterName&gt;&quot;</span>
<span class="nv">aksResourceGroup</span><span class="o">=</span><span class="s2">&quot;&lt;aksResourceGroup&gt;&quot;</span>
<span class="nv">appGatewayName</span><span class="o">=</span><span class="s2">&quot;&lt;appGatewayName&gt;&quot;</span>
<span class="nv">appGatewayResourceGroup</span><span class="o">=</span><span class="s2">&quot;&lt;appGatewayResourceGroup&gt;&quot;</span>

<span class="c1"># get aks vnet information</span>
<span class="nv">nodeResourceGroup</span><span class="o">=</span><span class="k">$(</span>az aks show -n <span class="nv">$aksClusterName</span> -g <span class="nv">$aksResourceGroup</span> -o tsv --query <span class="s2">&quot;nodeResourceGroup&quot;</span><span class="k">)</span>
<span class="nv">aksVnetName</span><span class="o">=</span><span class="k">$(</span>az network vnet list -g <span class="nv">$nodeResourceGroup</span> -o tsv --query <span class="s2">&quot;[0].name&quot;</span><span class="k">)</span>
<span class="nv">aksVnetId</span><span class="o">=</span><span class="k">$(</span>az network vnet show -n <span class="nv">$aksVnetName</span> -g <span class="nv">$nodeResourceGroup</span> -o tsv --query <span class="s2">&quot;id&quot;</span><span class="k">)</span>

<span class="c1"># get gateway vnet information</span>
<span class="nv">appGatewaySubnetId</span><span class="o">=</span><span class="k">$(</span>az network application-gateway show -n <span class="nv">$appGatewayName</span> -g <span class="nv">$appGatewayResourceGroup</span> -o tsv --query <span class="s2">&quot;gatewayIpConfigurations[0].subnet.id&quot;</span><span class="k">)</span>
<span class="nv">appGatewayVnetName</span><span class="o">=</span><span class="k">$(</span>az network vnet show --ids <span class="nv">$appGatewaySubnetId</span> -o tsv --query <span class="s2">&quot;name&quot;</span><span class="k">)</span>
<span class="nv">appGatewayVnetId</span><span class="o">=</span><span class="k">$(</span>az network vnet show --ids <span class="nv">$appGatewaySubnetId</span> -o tsv --query <span class="s2">&quot;id&quot;</span><span class="k">)</span>

<span class="c1"># set up bi-directional peering between aks and gateway vnet</span>
az network vnet peering create -n gateway2aks <span class="se">\</span>
    -g <span class="nv">$appGatewayResourceGroup</span> --vnet-name <span class="nv">$appGatewayVnetName</span> <span class="se">\</span>
    --remote-vnet <span class="nv">$aksVnetId</span> <span class="se">\</span>
    --allow-vnet-access
az network vnet peering create -n aks2gateway <span class="se">\</span>
    -g <span class="nv">$nodeResourceGroup</span> --vnet-name <span class="nv">$aksVnetName</span> <span class="se">\</span>
    --remote-vnet <span class="nv">$appGatewayVnetId</span> <span class="se">\</span>
    --allow-vnet-access
</pre></div>
<p>If you are using <code>Azure CNI</code> for network plugin with AKS, then you are good to go.</p>
<p>If you are using <code>Kubenet</code> network plugin, then jump to <a href="#with-kubenet">Kubenet</a> to setup the route table.</p>
<h2 id="network-plugin-used-with-aks">Network Plugin used with AKS</h2>
<h3 id="with-azure-cni">With Azure CNI</h3>
<p>When using Azure CNI, Every pod is assigned a VNET route-able private IP from the subnet. So, Gateway should be able reach the pods directly.</p>
<h3 id="with-kubenet">With Kubenet</h3>
<p>When using Kubenet mode, Only nodes receive an IP address from subnet. Pod are assigned IP addresses from the <code>PodIPCidr</code> and a route table is created by AKS. This route table helps the packets destined for a POD IP reach the node which is hosting the pod.</p>
<p>When packets leave Application Gateway instances, Application Gateway's subnet need to aware of these routes setup by the AKS in the route table.</p>
<p>A simple way to achieve this is by associating the same route table created by AKS to the Application Gateway's subnet. When AGIC starts up, it checks the AKS node resource group for the existence of the route table. If it exists, AGIC will try to assign the route table to the Application Gateway's subnet, given it doesn't already have a route table. If AGIC doesn't have permissions to any of the above resources, the operation will fail and an error will be logged in the AGIC pod logs.</p>
<p>This association can also be performed manually:</p>
<div class="highlight"><pre><span></span><span class="nv">aksClusterName</span><span class="o">=</span><span class="s2">&quot;&lt;aksClusterName&gt;&quot;</span>
<span class="nv">aksResourceGroup</span><span class="o">=</span><span class="s2">&quot;&lt;aksResourceGroup&gt;&quot;</span>
<span class="nv">appGatewayName</span><span class="o">=</span><span class="s2">&quot;&lt;appGatewayName&gt;&quot;</span>
<span class="nv">appGatewayResourceGroup</span><span class="o">=</span><span class="s2">&quot;&lt;appGatewayResourceGroup&gt;&quot;</span>

<span class="c1"># find route table used by aks cluster</span>
<span class="nv">nodeResourceGroup</span><span class="o">=</span><span class="k">$(</span>az aks show -n <span class="nv">$aksClusterName</span> -g <span class="nv">$aksResourceGroup</span> -o tsv --query <span class="s2">&quot;nodeResourceGroup&quot;</span><span class="k">)</span>
<span class="nv">routeTableId</span><span class="o">=</span><span class="k">$(</span>az network route-table list -g <span class="nv">$nodeResourceGroup</span> --query <span class="s2">&quot;[].id | [0]&quot;</span> -o tsv<span class="k">)</span>

<span class="c1"># get the application gateway&#39;s subnet</span>
<span class="nv">appGatewaySubnetId</span><span class="o">=</span><span class="k">$(</span>az network application-gateway show -n <span class="nv">$appGatewayName</span> -g <span class="nv">$appGatewayResourceGroup</span> -o tsv --query <span class="s2">&quot;gatewayIpConfigurations[0].subnet.id&quot;</span><span class="k">)</span>

<span class="c1"># associate the route table to Application Gateway&#39;s subnet</span>
az network vnet subnet update <span class="se">\</span>
--ids <span class="nv">$appGatewaySubnetId</span>
--route-table <span class="nv">$routeTableId</span>
</pre></div>
<p>### Further Readings</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/application-gateway/tutorial-ingress-controller-add-on-existing#peer-the-two-virtual-networks-together">Peer the two virtual networks together</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview">Virtual network peering</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-network/create-peering-different-subscriptions">How to peer your networks from different subscription</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/aks/configure-kubenet">Use kubenet to configure networking</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/aks/configure-azure-cni">Use CNI to configure networking</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/aks/concepts-network">Network concept for AKS and Kubernetes</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/aks/configure-kubenet#choose-a-network-model-to-use">When to decide to use kubenet or CNI</a></li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../minimize-downtime-during-deployments/" class="btn btn-neutral float-left" title="Minimizing Downtime During Deployments"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../scale-applications-using-appgw-metrics/" class="btn btn-neutral float-right" title="Scale your Applications using Application Gateway Metrics (Beta)">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../minimize-downtime-during-deployments/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../scale-applications-using-appgw-metrics/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
